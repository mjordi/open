name: PR Preview Deploy

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'frontend/**'
      - 'scripts/generate-frontend-artifacts.js'
      - 'scripts/build-frontend.js'
      - 'contracts/**'
      - 'hardhat.config.js'

# Sets permissions for the workflow
permissions:
  contents: write
  pull-requests: write
  pages: write
  id-token: write

jobs:
  build-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Checkout gh-pages branch (or create if doesn't exist)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if gh-pages branch exists
          if git ls-remote --heads origin gh-pages | grep -q gh-pages; then
            echo "gh-pages branch exists, checking out..."
            git clone --depth 1 --branch gh-pages https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git gh-pages-branch
          else
            echo "gh-pages branch does not exist, creating new one..."
            mkdir -p gh-pages-branch
            cd gh-pages-branch
            git init
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            # Create initial index.html
            cat > index.html << 'INDEXEOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Access Management - GitHub Pages</title>
            <meta http-equiv="refresh" content="0; url=./previews.html">
          </head>
          <body>
            <p>Redirecting to <a href="./previews.html">PR Previews</a>...</p>
          </body>
          </html>
          INDEXEOF

            git add index.html
            git commit -m "Initial gh-pages commit"
            git branch -M gh-pages

            # Add remote with authentication
            git remote add origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
            cd ..
          fi

      - name: Prepare preview directory
        run: |
          # Create preview directory for this PR
          mkdir -p gh-pages-branch/pr-${{ github.event.pull_request.number }}

          # Copy built files to preview directory
          cp -r frontend/dist/* gh-pages-branch/pr-${{ github.event.pull_request.number }}/

          # Create/update index of PR previews
          cd gh-pages-branch

          # Create preview index if it doesn't exist
          if [ ! -f "previews.html" ]; then
            cat > previews.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>PR Previews - Access Management</title>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <style>
              body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                max-width: 800px;
                margin: 50px auto;
                padding: 20px;
                line-height: 1.6;
              }
              h1 { color: #0d6efd; }
              .preview-list { list-style: none; padding: 0; }
              .preview-item {
                border: 1px solid #ddd;
                margin: 10px 0;
                padding: 15px;
                border-radius: 5px;
              }
              .preview-item:hover { background-color: #f8f9fa; }
              a { color: #0d6efd; text-decoration: none; }
              a:hover { text-decoration: underline; }
            </style>
          </head>
          <body>
            <h1>PR Preview Deployments</h1>
            <p>Available preview deployments for pull requests:</p>
            <ul class="preview-list" id="previews"></ul>
            <script>
              // List all PR directories
              fetch('.')
                .then(r => r.text())
                .then(html => {
                  const matches = html.matchAll(/href="pr-(\d+)\/"/g);
                  const prs = [...matches].map(m => m[1]).sort((a, b) => b - a);
                  const list = document.getElementById('previews');
                  prs.forEach(pr => {
                    const li = document.createElement('li');
                    li.className = 'preview-item';
                    li.innerHTML = `<strong>PR #${pr}</strong> - <a href="pr-${pr}/">View Preview</a>`;
                    list.appendChild(li);
                  });
                });
            </script>
          </body>
          </html>
          EOF
          fi

      - name: Commit and push to gh-pages
        working-directory: gh-pages-branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .

          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Deploy preview for PR #${{ github.event.pull_request.number }}"

            # Set up remote if not already configured
            if ! git remote | grep -q origin; then
              git remote add origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
            fi

            # Push to gh-pages branch
            git push origin gh-pages
          fi

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const previewUrl = `https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr-${prNumber}/`;

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Preview deployment')
            );

            const commentBody = `## ðŸš€ Preview Deployment

            Your changes have been deployed to a preview environment:

            **Preview URL:** ${previewUrl}

            This preview will be updated automatically when you push new commits to this PR.

            ---
            <sub>Built from commit: ${context.payload.pull_request.head.sha.substring(0, 7)}</sub>`;

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
            }
