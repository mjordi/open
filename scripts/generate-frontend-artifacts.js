/**
 * Generate frontend artifacts from compiled contracts
 * This script extracts ABI and bytecode from Hardhat artifacts
 * and generates JavaScript files for the frontend
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import { execSync } from 'child_process';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Paths
const ARTIFACTS_DIR = path.join(__dirname, '../artifacts/contracts');
const OUTPUT_DIR = path.join(__dirname, '../frontend/src/generated');
const CONTRACT_NAME = 'AccessManagement';
const CONTRACT_FILE = 'aaas.sol';

// Ensure output directory exists
if (!fs.existsSync(OUTPUT_DIR)) {
    fs.mkdirSync(OUTPUT_DIR, { recursive: true });
}

try {
    // Read the compiled contract artifact
    const artifactPath = path.join(ARTIFACTS_DIR, CONTRACT_FILE, `${CONTRACT_NAME}.json`);

    if (!fs.existsSync(artifactPath)) {
        console.log('Contract artifacts not found. Compiling contracts...');
        try {
            // Run Hardhat compilation with --force to ensure compilation happens
            execSync('npx hardhat compile --force', {
                stdio: 'inherit',
                cwd: path.join(__dirname, '..')
            });
            console.log('✓ Contracts compiled successfully');
        } catch (compileError) {
            console.error('Error: Failed to compile contracts');
            console.error('Please ensure Hardhat is properly configured and contracts are valid');
            process.exit(1);
        }

        // Check again if artifact exists after compilation
        if (!fs.existsSync(artifactPath)) {
            console.error(`Error: Contract artifact still not found at ${artifactPath}`);
            console.error('Please check your contract name and file path');
            process.exit(1);
        }
    }

    const artifact = JSON.parse(fs.readFileSync(artifactPath, 'utf8'));

    // Generate ABI file (compatible with both legacy and modern usage)
    const abiContent = `/**
 * Auto-generated from compiled contract
 * Contract: ${CONTRACT_NAME}
 * DO NOT EDIT MANUALLY - Run 'npm run generate' to regenerate
 */

const contractABI = ${JSON.stringify(artifact.abi, null, 2)};

// Legacy variable name for backward compatibility
const smartContractAbi = contractABI;
`;

    fs.writeFileSync(path.join(OUTPUT_DIR, 'abi.js'), abiContent);
    console.log('✓ Generated abi.js');

    // Generate bytecode file (compatible with both legacy and modern usage)
    const bytecodeContent = `/**
 * Auto-generated from compiled contract
 * Contract: ${CONTRACT_NAME}
 * DO NOT EDIT MANUALLY - Run 'npm run generate' to regenerate
 */

const contractBytecode = '${artifact.bytecode}';
`;

    fs.writeFileSync(path.join(OUTPUT_DIR, 'bytecode.js'), bytecodeContent);
    console.log('✓ Generated bytecode.js');

    console.log('\n✓ Frontend artifacts generated successfully!');
} catch (error) {
    console.error('Error generating frontend artifacts:', error.message);
    process.exit(1);
}
