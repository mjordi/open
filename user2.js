window.addEventListener('load', async () => {
  //Detecting MetaMask
  if (window.ethereum) {
    window.web3 = new Web3(ethereum);
    try {
      // Request account access if needed
      await ethereum.enable();
    } catch (error) {
      // User denied account access...
      var errorMsg = 'User denied account access!';
      $('#log').text(errorMsg);
      console.log(errorMsg);
      return;
    }
  }
  // Legacy dapp browsers...
  else if (window.web3) {
    window.web3 = new Web3(web3.currentProvider);
  }
  // Non-dapp browsers...
  else {
    var errorMsg =
      'Non-Ethereum browser detected. You should consider trying MetaMask!';
    $('#log').text(errorMsg);
    console.log(errorMsg);
    return;
  }

  //Set User from Metamask
  var user1Adress = web3.eth.accounts[0];
  console.log('Metamask Account: ' + user1Adress);
  web3.eth.getBalance(user1Adress, function (err, balance) {
    if (err === null) {
      console.log('Balance: ' + web3.fromWei(balance, 'ether') + ' ETH');
    }
  });

  //Initiate Standard Smart Contract
  var smartContract = web3.eth.contract(smartContractAbi);
  var smartContractAdress = '0x1614c607e0e36d210196941b954f9e5128f3e0f5';
  var smartContractInstance = smartContract.at(smartContractAdress);
  console.log(
    'Default Smart Contract Adress: ' + smartContractInstance.address
  );

  //Deploy Smart Contract
  $('#form_deploy').on('submit', function (e) {
    e.preventDefault();
    smartContractInstance = smartContract.new(
      {
        from: web3.eth.accounts[0],
        data: '0x608060405234801561001057600080fd5b506120ee806100206000396000f3006080604052600436106100a4576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063608661a4146100a95780637c66c2a51461015c5780637cbaf4a4146101fd5780637d57de6c146102e45780638978a6a2146103e6578063a0aead4d14610467578063a1fc67bd14610492578063a994a2da1461050f578063c75f6089146105d6578063cd5286d01461067c575b600080fd5b3480156100b557600080fd5b5061011a600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001909291905050506107a3565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34801561016857600080fd5b506101e3600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610852565b604051808215151515815260200191505060405180910390f35b34801561020957600080fd5b506102ca600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610ce1565b604051808215151515815260200191505060405180910390f35b3480156102f057600080fd5b5061036b600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803573ffffffffffffffffffffffffffffffffffffffff1690602001909291905050506112a1565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156103ab578082015181840152602081019050610390565b50505050905090810190601f1680156103d85780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b3480156103f257600080fd5b5061044d600480360381019080803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091929192905050506113f2565b604051808215151515815260200191505060405180910390f35b34801561047357600080fd5b5061047c611746565b6040518082815260200191505060405180910390f35b34801561049e57600080fd5b506104f9600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050611753565b6040518082815260200191505060405180910390f35b34801561051b57600080fd5b506105bc600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091929192905050506117cd565b604051808215151515815260200191505060405180910390f35b3480156105e257600080fd5b5061060160048036038101908080359060200190929190505050611cc5565b6040518080602001828103825283818151815260200191508051906020019080838360005b83811015610641578082015181840152602081019050610626565b50505050905090810190601f16801561066e5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34801561068857600080fd5b506106e3600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050611d80565b604051808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018060200184151515158152602001838152602001828103825285818151815260200191508051906020019080838360005b8381101561076557808201518184015260208101905061074a565b50505050905090810190601f1680156107925780820380516001836020036101000a031916815260200191505b509550505050505060405180910390f35b600080836040518082805190602001908083835b6020831015156107dc57805182526020820191506020810190506020830392506107b7565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206002018281548110151561081f57fe5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905092915050565b60003373ffffffffffffffffffffffffffffffffffffffff166000846040518082805190602001908083835b6020831015156108a3578051825260208201915060208101905060208303925061087e565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614806109d457506000836040518082805190602001908083835b60208310151561094f578051825260208201915060208101905060208303925061092a565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060030160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010160009054906101000a900460ff165b1515610a6e576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260338152602001807f4f6e6c7920746865206f776e6572206f722061646d696e732063616e2072656d81526020017f6f766520617574686f72697a6174696f6e732e0000000000000000000000000081525060400191505060405180910390fd5b60206040519081016040528060008152506000846040518082805190602001908083835b602083101515610ab75780518252602082019150602081019050602083039250610a92565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060030160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000019080519060200190610b4092919061201d565b50600080846040518082805190602001908083835b602083101515610b7a5780518252602082019150602081019050602083039250610b55565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060030160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010160006101000a81548160ff0219169083151502179055507f1a4590e74c17da0bf50c450883a372877f6ea86ce7048e248a2d8b0d279574a08284604051808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200180602001828103825283818151815260200191508051906020019080838360005b83811015610c9c578082015181840152602081019050610c81565b50505050905090810190601f168015610cc95780820380516001836020036101000a031916815260200191505b50935050505060405180910390a16001905092915050565b60003373ffffffffffffffffffffffffffffffffffffffff166000856040518082805190602001908083835b602083101515610d325780518252602082019150602081019050602083039250610d0d565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161480610e6357506000846040518082805190602001908083835b602083101515610dde5780518252602082019150602081019050602083039250610db9565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060030160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010160009054906101000a900460ff165b1515610efd576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260308152602001807f4f6e6c7920746865206f776e6572206f722061646d696e732063616e2061646481526020017f20617574686f72697a6174696f6e732e0000000000000000000000000000000081525060400191505060405180910390fd5b6000846040518082805190602001908083835b602083101515610f355780518252602082019150602081019050602083039250610f10565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206002018390806001815401808255809150509060018203906000526020600020016000909192909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050816000856040518082805190602001908083835b6020831015156110085780518252602082019150602081019050602083039250610fe3565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060030160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001908051906020019061109192919061201d565b5060016000856040518082805190602001908083835b6020831015156110cc57805182526020820191506020810190506020830392506110a7565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060030160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010160006101000a81548160ff0219169083151502179055507fc6593691aaa0fd1cd0ef2a16869a77697e425eecf281497fb8e545c04c0f762c838584604051808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018060200180602001838103835285818151815260200191508051906020019080838360005b838110156111f35780820151818401526020810190506111d8565b50505050905090810190601f1680156112205780820380516001836020036101000a031916815260200191505b50838103825284818151815260200191508051906020019080838360005b8381101561125957808201518184015260208101905061123e565b50505050905090810190601f1680156112865780820380516001836020036101000a031916815260200191505b509550505050505060405180910390a1600190509392505050565b60606000836040518082805190602001908083835b6020831015156112db57805182526020820191506020810190506020830392506112b6565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060030160008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156113e55780601f106113ba576101008083540402835291602001916113e5565b820191906000526020600020905b8154815290600101906020018083116113c857829003601f168201915b5050505050905092915050565b60003373ffffffffffffffffffffffffffffffffffffffff166000836040518082805190602001908083835b602083101515611443578051825260208201915060208101905060208303925061141e565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16148061157457506000826040518082805190602001908083835b6020831015156114ef57805182526020820191506020810190506020830392506114ca565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060030160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010160009054906101000a900460ff165b1561165f577f26c0ee6d5a073c88f03c3ebb80d902a771bbfc972ea49eee98e4b0263c89ce9f33836001604051808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018060200183151515158152602001828103825284818151815260200191508051906020019080838360005b8381101561161a5780820151818401526020810190506115ff565b50505050905090810190601f1680156116475780820380516001836020036101000a031916815260200191505b5094505050505060405180910390a160019050611741565b7f26c0ee6d5a073c88f03c3ebb80d902a771bbfc972ea49eee98e4b0263c89ce9f33836000604051808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018060200183151515158152602001828103825284818151815260200191508051906020019080838360005b838110156117005780820151818401526020810190506116e5565b50505050905090810190601f16801561172d5780820380516001836020036101000a031916815260200191505b5094505050505060405180910390a1600090505b919050565b6000600180549050905090565b600080826040518082805190602001908083835b60208310151561178c5780518252602082019150602081019050602083039250611767565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020600201805490509050919050565b600080836040518082805190602001908083835b60208310151561180657805182526020820191506020810190506020830392506117e1565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060040160009054906101000a900460ff1615611987577f8c162857a2babb214aa3eec53736fe29210ad6ec70bd43589c0d59c1c456308a3384604051808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018060200180602001838103835284818151815260200191508051906020019080838360005b838110156118e85780820151818401526020810190506118cd565b50505050905090810190601f1680156119155780820380516001836020036101000a031916815260200191505b50838103825260268152602001807f4173736574207769746820746869732053657269616c20616c7265616479206581526020017f78697374732e000000000000000000000000000000000000000000000000000081525060400194505050505060405180910390a160009050611cbf565b336000846040518082805190602001908083835b6020831015156119c0578051825260208201915060208101905060208303925061199b565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550816000846040518082805190602001908083835b602083101515611a6d5780518252602082019150602081019050602083039250611a48565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206001019080519060200190611ab692919061201d565b5060016000846040518082805190602001908083835b602083101515611af15780518252602082019150602081019050602083039250611acc565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060040160006101000a81548160ff0219169083151502179055506001839080600181540180825580915050906001820390600052602060002001600090919290919091509080519060200190611b7b92919061201d565b50507f94ed006719ac23b3ba97bc86ddc95b3bac36e3c5239ef00fad4f68e3b32418d3338484604051808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018060200180602001838103835285818151815260200191508051906020019080838360005b83811015611c17578082015181840152602081019050611bfc565b50505050905090810190601f168015611c445780820380516001836020036101000a031916815260200191505b50838103825284818151815260200191508051906020019080838360005b83811015611c7d578082015181840152602081019050611c62565b50505050905090810190601f168015611caa5780820380516001836020036101000a031916815260200191505b509550505050505060405180910390a1600190505b92915050565b6060600182815481101515611cd657fe5b906000526020600020018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015611d745780601f10611d4957610100808354040283529160200191611d74565b820191906000526020600020905b815481529060010190602001808311611d5757829003601f168201915b50505050509050919050565b600060606000806000856040518082805190602001908083835b602083101515611dbf5780518252602082019150602081019050602083039250611d9a565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff166000866040518082805190602001908083835b602083101515611e4e5780518252602082019150602081019050602083039250611e29565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206001016000876040518082805190602001908083835b602083101515611ebc5780518252602082019150602081019050602083039250611e97565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060040160009054906101000a900460ff166000886040518082805190602001908083835b602083101515611f385780518252602082019150602081019050602083039250611f13565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060020180549050828054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156120075780601f10611fdc57610100808354040283529160200191612007565b820191906000526020600020905b815481529060010190602001808311611fea57829003601f168201915b5050505050925093509350935093509193509193565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061205e57805160ff191683800117855561208c565b8280016001018555821561208c579182015b8281111561208b578251825591602001919060010190612070565b5b509050612099919061209d565b5090565b6120bf91905b808211156120bb5760008160009055506001016120a3565b5090565b905600a165627a7a72305820fa77172826fd15a159f0b0581a885d8a42f5f1138d8d4724468ec8a755997b3f0029',
        gas: '4000000', //add gasEstimate
      },
      function (e, contract) {
        console.log(e, contract);
        if (typeof contract.address !== 'undefined') {
          console.log(
            'Contract mined! address: ' +
              contract.address +
              ' transactionHash: ' +
              contract.transactionHash
          );
        }
      }
    );
  });

  //Add Asset
  $('#form_asset').on('submit', function (e) {
    e.preventDefault();
    console.log(
      "Adding Asset to Smart Contract '" +
        smartContractInstance.address +
        "'... \n"
    );
    smartContractInstance.newAsset(
      $('#assetKey').val(),
      $('#assetDescription').val(),
      function (error) {}
    );
    //Watch for role changes
    smartContractInstance.AssetCreate().watch(function (error, result) {
      if (!error) {
        console.log(
          "The asset '" +
            result.args.assetKey +
            ' / ' +
            result.args.assetDescription +
            "' was created by " +
            result.args.account
        );
      }
    });
    smartContractInstance.RejectCreate().watch(function (error, result) {
      if (!error) {
        console.log(
          result.args.message +
            'Serial: ' +
            result.args.assetKey +
            ' / Owner: ' +
            result.args.account
        );
      }
    });
  });

  //Add Authorization
  $('#form_assign').on('submit', function (e) {
    e.preventDefault();
    console.log(
      "Assigning Role in Smart Contract '" +
        smartContractInstance.address +
        "'... \n"
    );
    smartContractInstance.addAuthorization(
      $('#assetKey_assign').val(),
      $('#address_assign').val(),
      $('#role_assign').val(),
      function (error) {}
    );
    //Watch for role changes
    smartContractInstance.AuthorizationCreate().watch(function (error, result) {
      if (!error) {
        console.log(
          "The role '" +
            result.args.authorizationRole +
            "' was added to the asset '" +
            result.args.assetKey +
            "' for " +
            result.args.account
        );
      }
    });
  });

  //Check Role
  $('#form_isAssigned').on('submit', function (e) {
    e.preventDefault();
    console.log(
      "Checking Role in Smart Contract '" +
        smartContractInstance.address +
        "'... \n"
    );
    smartContractInstance.getAssetAuthorization(
      $('#assetKey_isAssigned').val(),
      $('#address_isAssigned').val(),
      function (error, res) {
        if (error) {
          console.log(error);
        }
        console.log(res);
        //console.log(web3.utils.hexToAscii(res));
        //console.log(res.c[0]); // Your "customerName"
      }
    );
  });

  //Access the Asset
  $('#form_access').on('submit', function (e) {
    e.preventDefault();
    console.log(
      "Try to access in Smart Contract '" +
        smartContractInstance.address +
        "'... \n"
    );
    smartContractInstance.getAccess(
      $('#assetKey_access').val(),
      function (error) {}
    );
    //Watch for access verification
    smartContractInstance.AccessLog().watch(function (error, result) {
      // Check if the access result grants permission
      if (!error) {
        if (result.args.accessGranted) {
          console.log(
            'Access was granted to ' +
              result.args.account +
              " for the Asset '" +
              result.args.assetKey +
              "'"
          );
        } else {
          console.log(
            'Access was NOT granted to ' +
              result.args.account +
              " for the Asset '" +
              result.args.assetKey +
              "'"
          );
        }
      }
    });
  });

  //Remove Authorization
  $('#form_unassign').on('submit', function (e) {
    e.preventDefault();
    console.log(
      "Unassigning Role in Smart Contract '" +
        smartContractInstance.address +
        "'... \n"
    );
    smartContractInstance.removeAuthorization(
      $('#assetKey_unassign').val(),
      $('#address_unassign').val(),
      function (error) {}
    );
    //Watch for role changes
    smartContractInstance.AuthorizationRemove().watch(function (error, result) {
      if (!error) {
        console.log(
          "The role was removed from the asset '" +
            result.args.assetKey +
            "' for " +
            result.args.account
        );
      }
    });
  });
});
